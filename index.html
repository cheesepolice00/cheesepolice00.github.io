/**
 * CHEESE 경찰청 통합 기록지 - Google Apps Script
 * 출퇴근, RP 실적, 벌금 관리 시스템
 */

// ===== POST 요청 처리 (데이터 저장) =====
function doPost(e) {
  try {
    var params = e.parameter;
    var sheetType = params.sheetType;
    var ss = SpreadsheetApp.getActiveSpreadsheet();

    var now = new Date();
    var dateString = Utilities.formatDate(now, "GMT+9", "yyyy-MM-dd HH:mm:ss");

    var workMinutes = 0;

    // 1. 출퇴근 로직
    if (sheetType === "commute") {
      workMinutes = handleCommuteLogic(ss, params, now, dateString);
    }
    // 2. RP 로직
    else if (sheetType === "rp") {
      var targetSheet = getOrCreateSheet(ss, "RP기록");
      targetSheet.appendRow([dateString, params.uid, params.userName, params.rpType, params.result]);
    }
    // 3. 벌금 로직
    else if (sheetType === "fine") {
      var targetSheet = getOrCreateSheet(ss, "벌금");
      targetSheet.appendRow([dateString, params.suspectUid, params.suspectName, params.policeUid, params.policeName, params.items, params.totalFine, params.totalTime]);
    }

    // 4. 종합 실적 업데이트
    updateTotalSheet(ss, params, sheetType, workMinutes);

    return ContentService.createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("Error: " + err.toString());
    return ContentService.createTextOutput(JSON.stringify({success: false, error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ===== GET 요청 처리 (데이터 조회) =====
function doGet(e) {
  try {
    var type = e.parameter.type;
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (type === "weeklyStats") {
      var result = {
        commute: [],
        rp: [],
        fine: []
      };
      
      // 출퇴근 데이터
      var commuteSheet = ss.getSheetByName("출퇴근");
      if (commuteSheet) {
        result.commute = commuteSheet.getDataRange().getValues();
      }
      
      // RP기록 데이터
      var rpSheet = ss.getSheetByName("RP기록");
      if (rpSheet) {
        result.rp = rpSheet.getDataRange().getValues();
      }
      
      // 벌금 데이터
      var fineSheet = ss.getSheetByName("벌금");
      if (fineSheet) {
        result.fine = fineSheet.getDataRange().getValues();
      }
      
      return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({error: "Invalid request"}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("GET Error: " + err.toString());
    return ContentService.createTextOutput(JSON.stringify({error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// ===== 출퇴근 전용 로직 =====
function handleCommuteLogic(ss, params, now, dateString) {
  var sheet = getOrCreateSheet(ss, "출퇴근");
  var data = sheet.getDataRange().getValues();
  var uid = params.uid;
  var minutesEarned = 0;

  if (params.commuteAction === "출근") {
    sheet.appendRow([uid, params.userName, dateString, "", ""]);
  }
  else if (params.commuteAction === "퇴근") {
    // 가장 최근의 미처리 출근 기록 찾기
    for (var i = data.length - 1; i >= 1; i--) {
      if (data[i][0].toString() === uid.toString() && data[i][3] === "") {
        var rowIndex = i + 1;
        var startTime = new Date(data[i][2]);
        var diffMs = now - startTime;
        minutesEarned = Math.floor(diffMs / (1000 * 60));

        sheet.getRange(rowIndex, 4).setValue(dateString);
        sheet.getRange(rowIndex, 5).setFormula('=MOD(D' + rowIndex + '-C' + rowIndex + ',1)');
        break;
      }
    }
  }
  return minutesEarned;
}

// ===== 종합 실적 업데이트 =====
function updateTotalSheet(ss, params, type, newMinutes) {
  var sheet = getOrCreateSheet(ss, "종합 실적");
  var data = sheet.getDataRange().getValues();

  var uid = (type === "fine") ? params.policeUid : params.uid;
  var name = (type === "fine") ? params.policeName : params.userName;
  if (!uid || !name) return;

  var rowIndex = -1;
  
  // 기존 사용자 찾기
  for (var i = 1; i < data.length; i++) {
    if (data[i][0].toString() === uid.toString()) { 
      rowIndex = i + 1; 
      break; 
    }
  }

  // 신규 사용자 추가
  if (rowIndex === -1) {
    sheet.appendRow([uid, name, "", "", "", ""]);
    rowIndex = sheet.getLastRow();
  }

  // RP 승리 카운트 업데이트
  if (type === "rp" && params.result === "승리") {
    var rpSheet = ss.getSheetByName("RP기록");
    var rpData = rpSheet ? rpSheet.getDataRange().getValues() : [];
    var rpWinCount = 0;
    var rpTotalCount = 0;
    
    for (var j = 1; j < rpData.length; j++) {
      if (rpData[j][1].toString() === uid.toString()) {
        rpTotalCount++;
        if (rpData[j][4] === "승리") rpWinCount++;
      }
    }
    
    sheet.getRange(rowIndex, 4).setValue(rpWinCount);
    sheet.getRange(rowIndex, 5).setValue(rpTotalCount);
  }

  // 벌금 합계 업데이트
  if (type === "fine") {
    var fineSheet = ss.getSheetByName("벌금");
    var fineData = fineSheet ? fineSheet.getDataRange().getValues() : [];
    var totalFine = 0;
    
    for (var k = 1; k < fineData.length; k++) {
      if (fineData[k][3].toString() === uid.toString()) {
        var fineAmount = fineData[k][6];
        if (typeof fineAmount === 'string') {
          fineAmount = parseInt(fineAmount.replace(/[^0-9]/g, ''), 10) || 0;
        }
        totalFine += fineAmount;
      }
    }
    
    sheet.getRange(rowIndex, 6).setValue(totalFine);
  }
}

// ===== 시트 생성/조회 =====
function getOrCreateSheet(ss, name) {
  var sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    var header = [];
    
    if (name === "종합 실적") {
      header = ["고유번호", "이름", "총 근무시간", "RP승리", "총 RP횟수", "총 벌금 부과액"];
    } 
    else if (name === "벌금") {
      header = ["날짜", "범죄자 고번", "범죄자 이름", "경찰 고번", "경찰 이름", "위반항목", "벌금", "총 구금 시간"];
    } 
    else if (name === "출퇴근") {
      header = ["고유번호", "이름", "출근시간", "퇴근시간", "총 근무시간"];
    } 
    else if (name === "RP기록") {
      header = ["날짜", "고유번호", "이름", "종류", "결과"];
    }

    sheet.appendRow(header);
    sheet.getRange(1, 1, 1, header.length).setBackground("#D3D3D3").setFontWeight("bold");
  }
  
  return sheet;
}
